name: Build Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:

#  workflow_dispatch:
#    inputs:
#      build_configuration:
#        description: 'Build configuration'
#        default: 'Release'

jobs:
  build-dll:
    runs-on: windows-2025
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v5.0.0
    - uses: microsoft/setup-msbuild@v1.0.2
    - name: Install DepotDownloader and download Valheim files
      run: |
        winget install --exact --id SteamRE.DepotDownloader --disable-interactivity --accept-source-agreements --accept-package-agreements
        $depot = Get-ChildItem -Path $env:LOCALAPPDATA/Microsoft/WinGet -Recurse -Filter "DepotDownloader.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        & $depot.FullName -app 896660 -os windows -filelist .depot-downloader-file-list.txt -dir serverfiles

    - name: build
      env:
        VALHEIM_DEDI_INSTALL: ../../serverfiles
      run: |
        xcopy /E /I lib\* serverfiles\
        msbuild /t:Restore,Build -p:Configuration=Release
        
    - name: upload
      uses: actions/upload-artifact@v4.6.2
      with:
        name: serverside-simulations-${{ github.sha }}
        path: bin\Release\Serverside_Simulations.dll
  
  thunderstore-package:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-dll]
    steps:
    - uses: actions/checkout@v5.0.0
    - uses: actions/download-artifact@v5.0.0
    - name: Build Thunderstore Package
      run: |
        ls $GITHUB_WORKSPACE
        bin/thunderstore-package.sh
    - uses: actions/upload-artifact@v4.6.2
      with:
        name: thunderstore-package-${{ github.sha }}.zip
        path: thunderstore-package.zip 
